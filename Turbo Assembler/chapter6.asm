;********************************************;VISIBLE MONITOR;;APPENDIX C2: ASSEMBLER LISTING OF;THE VISIBLE MONITOR;TOP LEVEL AND DISPLAY SUBROUTINES;SEE CHAPTER 6 OF TOP-DOWN ASSEMBLY LANGUAGE;PROGRAMMING FOR YOUR COMMODORE 64 AND VIC;BY KEN SKIER;COPYRIGHT (C) 1984 BY KENNETH SKIER;LEXINGTON, MASSACHUSETTS;********************************************;BINARY   DETERMINE WHETHER ACCUMULATOR HOLDS THE ASCII REPRESEN-;         TATION FOR A HEXADECIMAL DIGIT. IF SO, RETURN BINARY REPRESEN-;         TATION FOR THAT DIGIT. IF NOT, RETURN AN ERROR CODE ($FF).;CALLSL   CALL THE CURRENTLY SELECTED ADDRESS AS A SUBROUTINE.;DECSL   SELECT PREVIOUS ADDRESS, BY DECREMENTING SELECT POINTER.;GETKEY   GET A CHARACTER FROM THE KEYBOARD BY CALLING MACHINE'S;         READ-ONLY MEMORY ROUTINE INDIRECTLY.;GETSL   GET BYTE AT CURRENTLY SELECTED ADDRESS.;GO       LOAD REGISTERS FROM DISPLAYED IMAGES AND CALL DISPLAYED AD-;         DRESS. UPON RETURN, RESTORE REGISTER IMAGES FROM REGISTERS.;INCSL   SELECT NEXT BYTE (INCREMENT SELECT POINTER).;PUTSL   STORE ACCUMULATOR AT CURRENTLY SELECTED ADDRESS.;VISMON   LET USER GIVE THE VISIBLE MONITOR COMMANDS UNTIL USER;         PRESSES 'Q' TO QUIT.;********************************************;;VARIABLES;;********************************************FIELD  .BYTE 0 ;FIELD HOLDS THE NUMBER OF THE CURRENT               ;FIELD.REGA   .BYTE 0 ;REGA HOLDS THE IMAGE OF REGISTER A               ;(THE ACCUMULATOR).REGX   .BYTE 0 ;REGX HOLDS THE IMAGE OF REGISTER X.REGY   .BYTE 0 ;REGY HOLDS THE IMAGE OF REGISTER Y.REGP   .BYTE 0 ;REGP HOLDS THE IMAGE OF THE PROCESSOR               ;STATUS REGISTER.REGS = REGA    ;               ;SELECT .WORD 0 ;THIS POINTS TO THE CURRENTLY SELECTED               ;BYTE.;LBLCOL .BYTE 0          ;THIS IS A COUNTER.LABELS .TEXT "A  X  Y  P"  ;THESE ARE THE CHARACTERSFIELDS .BYTE 3,6,8   ;THIS DATA AREA SHOWS WHICH COLUMN       .BYTE $0B,$0E ;SHOULD GET AN UP-ARROW TO INDICATE       .BYTE $11,$14 ;OF THESE VALUES WILL CAUSE THE UP-ARROW                     ;TO APPEAR IN A DIFFERENT COLUMN WHEN IN-                     ;DICATING A GIVEN FIELD.TEMP   .BYTE 0       ;THIS BYTE HOLDS THE TEMPORARY VARIABLE                     ;USED BY ROLSL.;********************************************;;THE VISIBLE MONITOR;;********************************************VISMON =*          ;       CLD         ;CLEAR DECIMAL MODE, SINCE                   ;ARITHMETIC OPERATIONS IN THIS                   ;BOOK ARE ALWAYS BINARY.                   ;       JSR LDREG   ;LOAD REGISTER IMAGES                   ;LOOPV  JSR DSPLAY  ;PUT MONITOR DISPLAY ON SCREEN.                   ;       ;JSR TVDUMP  ;                   ;       JSR UPDATE  ;GET USER REQUEST AND HANDLE IT.                   ;              CLC         ;       BCC LOOPV   ;LOOP BACK TO DISPLAY...;********************************************;;MONITOR-DISPLAY;;********************************************DSPLAY JSR TVPUSH  ;SAVE ZERO PAGE BYTES THAT                   ;WILL BE MODIFIED.                   ;       ;JSR CLRTV  ;                   ;       JSR CLRMON  ;CLEAR MONITOR'S PORTION OF SCREEN.       JSR LINEL   ;DISPLAY THE LABEL LINE.       JSR LINE2   ;DISPLAY THE DATA LINE.       JSR LINE3   ;DISPLAY THE ARROW LINE.                   ;       JSR TVPOP   ;RESTORE ZERO PAGE BYTES                   ;THAT WERE SAVED ABOVE.       RTS         ;RETURN TO CALLER.;********************************************;;CLRMON;;********************************************CLRMON LDX #0      ;SET TVPTR TO COLUMN 0, ROW 0 OF       LDY #0      ;SCREEN.                   ;       JSR TVTOXY  ;                   ;       LDX TVCOLS  ;WE'LL CLEAR THE FULL WIDTH OF THE                   ;       LDY #5      ;LOAD Y WITH NUMBER OF                   ;ROWS (3) TO BE CLEARED.                   ;       JSR CLRXY   ;CLEAR X COLUMNS, Y ROWS.                   ;       RTS         ;RETURN TO CALLER.;********************************************;;LINEL;;********************************************LINEL  LDX #11      ;X-COORDINATE OF LABEL "A".       ;LDY #0       ;Y-COORDINATE OF LABEL "A".       LDY #2       ;Y-COORDINATE OF LABEL "A".       JSR TVTOXY   ;PLACE TVPTR AT COORDINATES GIVEN BY                    ;X,Y REGISTERS.       LDY #0       ;PUT LABELS ON THE SCREEN:       STY LBLCOL   ;INITIALIZE LABEL COLUMN COUNTER.LBLOOP LDA LABELS,Y ;GET A CHARACTER AND       JSR VUCHAR   ;PUT ITS GRAPHIC ON THE SCREEN.       INC LBLCOL   ;PREPARE FOR NEXT CHARACTER.       LDY LBLCOL   ;USE LABEL COLUMN AS AN INDEX.       CPY #10      ;DONE LAST CHARACTER?       BNE LBLOOP   ;IF NOT, DO NEXT ONE.       RTS          ;RETURN TO CALLER.;********************************************;;LINE2;;********************************************LINE2  LDX #0       ;LOAD X REGISTER WITH X-COORDINATE FOR                    ;START OF DATA LINE.       ;LDY #1       ;LOAD Y REGISTER WITH Y-COORDINATE FOR       LDY #3       ;LOAD Y REGISTER WITH Y-COORDINATE FOR                    ;DATA LINE.       JSR TVTOXY   ;SET TVPTR TO POINT TO THE START OF THE                    ;DATA LINE.       LDA SELECT+1 ;DISPLAY HIGH BYTE OF THE       JSR VUBYTE   ;CURRENTLY SELECTED ADDRESS.       LDA SELECT   ;DISPLAY LOW BYTE OF THE       JSR VUBYTE   ;CURRENTLY SELECTED ADDRESS.;       JSR TVSKIP   ;SKIP ONE SPACE AFTER ADDRESS FIELD.       JSR GETSL    ;LOOK UP VALUE OF THE CURRENTLY SELECTED                    ;BYTE.       PHA          ;SAVE IT.       JSR VUBYTE   ;DISPLAY IT, IN HEXADECIMAL FORMAT, IN                    ;FIELD 1.       JSR TVSKIP   ;SKIP ONE SPACE AFTER FIELD 1.       PLA          ;RESTORE VALUE OF CURRENTLY SELECTED BYTE.       JSR VUCHAR   ;DISPLAY THAT BYTE, IN GRAPHIC                    ;FORM, IN FIELD 2.       JSR TVSKIP   ;SKIP ONE SPACE AFTER FIELD 2.              LDX #0       ;DISPLAY 6502 REGISTER IMAGES IN FIELDS 4                    ;THRU 7:VUREGS LDA REGS,X   ;LOOK UP THE REGISTER IMAGE.       JSR VUBYTE   ;DISPLAY IT IN HEXADECIMAL FORMAT.       JSR TVSKIP   ;SKIP ONE SPACE AFTER HEXADECIMAL FIELD.       INX          ;GET READY FOR NEXT REGISTER...       CPX #4       ;DONE 4 REGISTERS YET?;       BNE VUREGS   ;IF NOT, DO NEXT ONE...       RTS          ;IF ALL REGISTERS DISPLAYED, RETURN.;********************************************;;GET CURRENTLY SELECTED BYTE;;********************************************GETSL  LDA GETPTR     ;SAVE GETPTR       PHA            ;ON STACK AND       LDA GETPTR+1   ;       PHA            ;;       LDA SELECT     ;SET GETPTR       STA GETPTR     ;EQUAL TO       LDA SELECT+1   ;SELECT.       STA GETPTR+1   ;;       LDY #0         ;GET THE CONTENTS OF THE       LDA (GETPTR),Y ;BYTE POINTED TO BY SELECT,       TAY            ;AND SAVE IT IN Y REGISTER.;       PLA            ;RESTORE GETPTR       STA GETPTR     ;FROM STACK       PLA       STX GETPTR+1   ;AND FROM X REGISTER.                      ;       TYA            ;RESTORE CONTENTS OF CURRENT BYTE FROM                      ;TEMPORARY STORAGE IN Y TO A.       RTS            ;RETURN WITH CONTENTS OF CURRENTLY                      ;SELECTED BYTE IN ACCUMULATOR AND WITH                      ;THE ZERO PAGE PRESERVED.;********************************************;;LINE3;;********************************************LINE3  LDY FIELD     ;LOOK UP CURRENT FIELD.       SEC           ;IF IT IS OUT OF BOUNDS,;       CPY #7        ;SET IT TO       BCC FLDOK     ;DEFAULT FIELD       LDY #0        ;(THE ADDRESS FIELD).       STY FIELD     ;FLDOK  LDA FIELDS,Y  ;LOOK UP COLUMN NUMBER FOR CURRENT                     ;FIELD.       TAX           ;THAT WILL BE THE ARROW'S                     ;X-COORDINATE.       ;LDY #2        ;SET ARROW'S Y-COORDINATE.       LDY #4        ;SET ARROW'S Y-COORDINATE.       JSR TVTOXY    ;MAKE TVPTR POINT TO ARROW                     ;LOCATION.       LDA ARROW     ;PLACE AN UP-ARROW IN       JSR VUCHAR    ;THAT LOCATION.       RTS           ;RETURN TO CALLER.;********************************************;;LDREG;;********************************************LDREG  PHP           ;WHEN SUBROUTINE RETURNS,       STA REGA      ;SAVE REGISTER VALUES IN REGISTER       STX REGX      ;IMAGES.       STY REGY      ;       PLA           ;       STA REGP      ;       RTS           ;THEN RETURN TO CALLER.;********************************************;APPENDIX C3: ASSEMBLER LISTING OF;THE VISIBLE MONITOR;UPDATE SUBROUTINE;SEE CHAPTER 6 OF TOP-DOWN ASSEMBLY-LANGUAGE;PROGRAMMING FOR YOUR COMMODORE 64 AND VIC-20;BY KEN SKIER;COPYRIGHT (C) 1984 BY KENNETH SKIER;LEXINGTON, MASSACHUSETTS;********************************************;;GETKEY;;********************************************GETKEY JMP (ROMKEY) ;JSR GETKEY CALLS THE                    ;COMMODORE KEYBOARD INPUT                    ;ROUTINE INDIRECTLY.;********************************************;;UPDATE;; RIGHT ARROW MOVE POINTER RIGHT; LEFT ARROW  MOVE POINTER LEFT; SPACE BAR   INCREMENT SELECTED ADDRESS; RETURN      DECREMENT SELECTED ADDRESS; GO          CALL CODE AT SELECTED ADDRESS;;********************************************UPDATE JSR GETKEY   ;GET A CHARACTER FROM THE KEYBOARD.                    ;IFGRTR CMP #$1D     ;IS IT THE RIGHT-ARROW KEY?       BNE IFLFT    ;IF NOT, PERFORM TEXT TEST.                    ;NEXTF  INC FIELD    ;IF SO, SELECT THE NEXT FIELD.       LDA FIELD    ;IF ARROW WAS AT THE RIGHT-MOST FIELD,       CMP #7       ;PLACE IT UNDERNEATH THE LEFT-MOST       BNE UPEX1    ;FIELD.       LDA #0       ;       STA FIELD    ;UPEX1  RTS          ;THEN RETURN.                    ;IFLFT  CMP #$9D     ;IS IT THE LEFT-ARROW KEY?       BNE IFSP     ;IF NOT, PERFORM NEXT TEST.                    ;PREVF  DEC FIELD    ;IF SO, SELECT PREVIOUS FIELD:       BPL UPEX2    ;THE FIELD TO THE LEFT OF THE       LDA #6       ;CURRENT FIELD. IF ARROW WAS AT       STA FIELD    ;LEFT-MOST FIELD, PLACE IT UNDER                    ;RIGHT-MOST FIELD.UPEX2  RTS          ;THEN RETURN.                    ;IFSP   CMP #SPACE   ;IS IT THE SPACE BAR?       BNE IFCR     ;IF NOT, PERFORM NEXT TEST.                    ;INCSL  INC SELECT   ;IF SO, STEP FORWARD THROUGH       BNE EXIT3    ;MEMORY, BY INCREMENTING THE       INC SELECT+1 ;POINTER THAT SPECIFIES THE DISPLAYED                    ;ADDRESS.EXIT3  RTS          ;THEN RETURN                    ;IFCR   CMP #CR      ;IS IT CARRIAGE RETURN?       BNE IFCHAR   ;IF NOT, PERFORM NEXT TEST.;DECSL  LDA SELECT   ;IF SO, STEP BACKWARD THROUGH       BNE NEXT3    ;MEMORY BY DECREMENTING THE       DEC SELECT+1 ;POINTER THAT SELECTS THENEXT3  DEC SELECT   ;ADDRESS TO BE DISPLAYED.       RTS          ;THEN RETURN.                    ;IFCHAR LDX FIELD    ;IS ARROW UNDERNEATH THE       CPX #2       ;CHARACTER FIELD (FIELD 2)?       BNE IFGO     ;IF NOT, PERFORM NEXT TEST.                    ;PUT THE CONTENTS OF A INTO THE CURRENTLY                    ;SELECTED ADDRESS.PUTSL  TAY          ;USE Y TO HOLD THE CHARACTER WELL PUT IN                    ;THE SELECTED ADDRESS.       LDA TVPTR    ;SAVE ZERO-PAGE POINTER TVPTR       PHA          ;ON STACK AND IN X BEFORE WE       LDX TVPTR+ 1 ;USE IT TO PUT CHARACTER IN SELECTED AD-                    ;DRESS.       LDA SELECT   ;SET TVPTR EQUAL TO SELECT,       STA TVPTR    ;SO IT POINTS TO THE       LDA SELECT+1 ;CURRENTLY SELECTED       STA TVPTR+ 1 ;ADDRESS.       TYA          ;RESTORE TO A THE CHARACTER WE'LL PUT IN                    ;THE SELECTED ADDRESS.       LDY #0       ;STORE IT IN THE       STA (TVPTR),Y ;SELECTED ADDRESS.       STX TVPTR+1  ;RESTORE TVPTR TO       PLA           ;ITS ORIGINAL VALUE.       STA TVPTR     ;       RTS           ;RETURN TO CALLER, WITH CHARACTER ORIGI-                     ;NALLY IN A NOW IN THE SELECTED ADDRESS                     ;AND WITH ZERO PAGE UNCHANGED.IFGO   CMP #"G"      ;IS IT 'G' FOR GO?                     ;SHIFT G       BNE IFHEX     ;IF NOT, PERFORM NEXT TEST.                     ;GO     LDY REGY      ;IF SO, LOAD THE 6502 REGISTERS       LDX REGX      ;WITH THEIR DISPLAYED IMAGES.       LDA REGP      ;       PHA           ;       LDA REGA      ;       PLP           ;       JSR CALLIT    ;CALL THE SUBROUTINE AT THE SELECTED AD-                     ;DRESS.       PHP           ;WHEN SUBROUTINE RETURNS,       STA REGA      ;SAVE REGISTER VALUES IN REGISTER       STX REGX      ;IMAGES.       STY REGY      ;       PLA           ;       STA REGP      ;       RTS           ;THEN RETURN TO CALLER.                     ;CALLIT JMP (SELECT)  ;CALL THE SUBROUTINE AT THE SELECTED AD-                     ;DRESS.IFHEX  PHA           ;SAVE KEYBOARD CHARACTER.       JSR BINARY    ;IF ACCUMULATOR HOLDS ASCII CHARACTER                     ;FOR 0 THRU 9 OR A THRU F, BINARY                     ;RETURNS THE BINARY REPRESENTATION OF THAT                     ;HEXADECIMAL DIGIT. OTHERWISE BINARY                     ;RETURNS WITH A = FF AND THE MINUS FLAG                     ;SET.       BMI IFCLR     ;IF ACCUMULATOR DID NOT HOLD A HEXA                     ;DECIMAL CHARACTER, PERFORM NEXT TEST.       TAY           ;       PLA           ;       TYA           ;                     ;       LDX FIELD    ;ROLL A INTO A HEXADECIMAL FIELD.       BNE NOTADR   ;IS ARROW UNDERNEATH THE ADDRESS FIELD                     ;(FIELD 0)? IF NOT, THE ARROW MUST BE                     ;UNDER ANOTHER HEXADECIMAL FIELD.ADRFLD LDX #3        ;SINCE ARROW IS UNDERNEATH THE ADDRESSADLOOP CLC           ;FIELD, ROLL ACCUMULATOR'S HEXADECIMAL       ASL SELECT    ;DIGIT INTO THE ADDRESS FIELD BY ROLLING IT       ROL SELECT+1  ;INTO THE POINTER THAT SELECTS THE       DEX           ;DISPLAYED ADDRESS.       BPL ADLOOP    ;       TYA           ;       ORA SELECT    ;       STA SELECT    ;       RTS           ;THEN RETURN.                     ;NOTADR CPX #1        ;IS ARROW UNDERNEATH FIELD 1?       BNE REGFLD    ;IF NOT, IT MUST BE UNDERNEATH A REGISTER                     ;IMAGE.ROLSL  AND #$0F      ;ROLL A'S 4 LSB INTO CONTENTS       PHA           ;OF CURRENTLY SELECTED BYTE.       JSR GETSL     ;GET THE CONTENTS OF THE SELECTED       ASL A         ;ADDRESS AND SHIFT LEFT 4 TIMES.       ASL A         ;       ASL A         ;       ASL A         ;       AND #$F0      ;       STA TEMP      ;SAVE IT IN A TEMDORARV VARIABLE.       PLA           ;GET ORIGINAL A'S 4 LSB AND       ORA TEMP      ;OR THEM WITH SHIFTED CONTENTS OF                     ;SELECTED ADDRESS.       JSR PUTSL     ;STORE THE RESULT IN THE SELECTED       RTS           ;ADDRESS AND RETURN.                     ;REGFLD DEX           ;THE ARROW MUST BE UNDERNEATH A       DEX           ;REGISTER IMAGE — FIELD 3, 4, 5, OR 6.       DEX           ;       LDY #3        ;                     ;RGLOOP CLC           ;ROLL ACCUMULATOR'S HEXADECIMAL DIGIT       ASL REGS,X    ;INTO APPROPRIATE REGISTER IMAGE...       DEY           ;       BPL RGLOOP     ;       ORA REGS,X    ;       STA REGS,X    ;       RTS           ;...THEN RETURN.                     ;IFCLR  PLA       CMP #CLRKEY              BNE NOTCLR              JSR CLRTV       RTS                      ;NOTCLR CMP #"Q"      ;IS IT Q' FOR QUIT?                     ;SHIFT Q       BNE OTHER     ;IF NOT, PERFORM NEXT TEST.                     ;                     ;USER WANTS TO RETURN TO THE                     ;CALLER OF THE VISIBLE                     ;MONITOR. SO LET'S DO THAT:OEXIT  PLA           ;POP UPDATE'S RETURN ADDRESS.       PLA           ;              PLP           ;RESTORE INITIAL 6502 FLAGS.                     ;VISMON RETURN ADDRESS IS                     ;NOW ON THE STACK.       RTS           ;SO RETURN TO CALLER OF                     ;VISMON. IN THIS WAY,                     ;VISMON CAN BE USED BY ANY                     ;CALLER TO GET AN ADDRESS                     ;FROM THE USER.                     ;;OTHER  JSR DUMMY      ;REPLACE THIS CALL TO                      ;DUMMY WITH A CALL TO ANY                      ;SUBROUTINE THAT EXTENDS                      ;FUNCTIONALITY OF THE                      ;VISIBLE MONITOR.;       RTS            ;...RETURN                      ;OTHER  JSR EXTEND    ;EXTENSION TO ADD HEX DUMP,MOVE,                      ;TEXT EDITOR AND DISASSEMBLER                     ;FUNCTIONALITY TO THE VISIBLE MONITOR.       RTS            ;...RETURN;********************************************;;BINARY;;********************************************BINARY SEC         ;PREPARE TO SUBTRACT.       SBC #$30    ;SUBTRACT $30 FROM CHARACTER.       BCC BAD     ;IF CHARACTER WAS ORIGINALLY LESS THAN $30,                   ;IT WAS BAD, SO RETURN $FF.       CMP #$0A    ;WAS CHARACTER IN THE RANGE $30 THRU                   ;$39?       BCC GOOD    ;IF SO, IT WAS A GOOD INPUT, AND WE'VE                   ;ALREADY CONVERTED IT TO BINARY BY SUB-                   ;TRACTING $30, SO WE'LL RETURN NOW WITH                   ;THE CHARACTER'S BINARY EQUIVALENT IN THE                   ;ACCUMULATOR.       SBC #7      ;SUBTRACT 7.       CMP #$10    ;WAS CHARACTER ORIGINALLY IN THE RANGE                   ;$41 THRU $46?       BCS BAD     ;IF SO, IT WAS A BAD INPUT.       SEC       CMP #$0A       BCS GOODBAD    LDA #$FF   ;INDICATE A BAD INPUT BY RETURNING       RTS        ;MINUS, WITH A HOLDING $FF.GOOD   LDX #0     ;INDICATE A GOOD INPUT BY RETURNING       RTS        ;PLUS, WITH A HOLDING THE CHARACTER'S                  ;BINARY EQUIVALENT.;********************************************;;;;********************************************.END